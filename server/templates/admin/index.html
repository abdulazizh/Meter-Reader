<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f5f7fa;
      color: #1a1a2e;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #1e5799 0%, #2989d8 50%, #207cca 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .header-stats {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 20px;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .tab:hover {
      background: #f0f4f8;
    }
    
    .tab.active {
      background: #1e5799;
      color: white;
    }
    
    .panel {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .panel.active {
      display: block;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .panel-title {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a2e;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #1e5799;
      color: white;
    }
    
    .btn-primary:hover {
      background: #164378;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }
    
    th.sortable {
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    th.sortable:hover {
      background: #e9ecef;
    }
    
    th.sortable::after {
      content: ' â‡…';
      opacity: 0.3;
      font-size: 12px;
    }
    
    th.sortable.asc::after {
      content: ' â†‘';
      opacity: 1;
    }
    
    th.sortable.desc::after {
      content: ' â†“';
      opacity: 1;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .filters-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .filter-group label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
    }
    
    .filter-group input, .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      min-width: 150px;
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #1e5799;
    }
    
    .btn-reset-filters {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      margin-top: 20px;
    }
    
    .btn-reset-filters:hover {
      background: #5a6268;
    }
    
    .results-count {
      font-size: 14px;
      color: #666;
      margin-top: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
      direction: rtl;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #1e5799;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .upload-area:hover {
      border-color: #1e5799;
      background: #f8f9fa;
    }
    
    .upload-area input {
      display: none;
    }
    
    .upload-icon {
      font-size: 48px;
      color: #ddd;
      margin-bottom: 15px;
    }
    
    .upload-text {
      color: #666;
      font-size: 16px;
    }
    
    .upload-hint {
      color: #999;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .photo-link {
      text-decoration: none;
    }
    
    .photo-link:hover .badge {
      opacity: 0.8;
      transform: scale(1.05);
    }
    
    .photo-link .badge {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-box input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1e5799;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    /* Dashboard specific styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .kpi-card {
      background: white;
      padding: 20px 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
      border-top: 5px solid #1e5799;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .kpi-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%);
      pointer-events: none;
    }
    
    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      color: #1e5799;
      margin: 8px 0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    
    .kpi-label {
      font-size: 13px;
      color: #666;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
    }
    
    .chart-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1a1a2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kpi-progress-container {
      width: 100%;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      margin-top: 15px;
      overflow: hidden;
    }
    
    .kpi-progress-bar {
      height: 100%;
      background: #28a745;
      border-radius: 4px;
      transition: width 0.5s ease-out;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h1>
    <div class="header-stats">
      <div class="stat-item">
        <div class="stat-value" id="totalReaders">0</div>
        <div class="stat-label">Ø§Ù„Ù‚Ø±Ø§Ø¡</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalMeters">0</div>
        <div class="stat-label">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalReadings">0</div>
        <div class="stat-label">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div>
      </div>
      <button class="logout-btn" onclick="handleLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <div class="container">
    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>

    <div class="tabs">
      <button class="tab active" data-tab="dashboard">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      <button class="tab" data-tab="readers">Ø§Ù„Ù‚Ø±Ø§Ø¡</button>
      <button class="tab" data-tab="meters">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</button>
      <button class="tab" data-tab="readings">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</button>
      <button class="tab" data-tab="import">Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="tab" data-tab="export">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <!-- Dashboard Panel -->
    <div class="panel active" id="dashboard-panel">
      <div class="panel-header">
        <h2 class="panel-title">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <button class="btn btn-secondary" onclick="loadDashboardStats()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      
      <div id="stats-loading" class="loading">
        <div class="spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      </div>

      <div class="dashboard-grid">
        <div class="kpi-card">
          <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
          <div class="kpi-value" id="kpi-completion">- %</div>
          <div class="kpi-progress-container">
            <div class="kpi-progress-bar" id="kpi-completion-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="kpi-card" style="border-right-color: #28a745;">
          <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
          <div class="kpi-value" id="kpi-amounts">- Ø¯.Ø¹</div>
        </div>
        <div class="kpi-card" style="border-right-color: #dc3545;">
          <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
          <div class="kpi-value" id="kpi-debts">- Ø¯.Ø¹</div>
        </div>
        <div class="kpi-card" style="border-right-color: #ffc107;">
          <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø¨Ø§ÙŠØ©</div>
          <div class="kpi-value" id="kpi-ratio">- %</div>
        </div>
      </div>

      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù</div>
          <canvas id="categoriesChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª (Ù…ÙƒØªÙ…Ù„Ø© / Ù…ØªØ®Ø·Ø§Ø©)</div>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card" style="grid-column: span 2;">
          <div class="chart-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡ (Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª)</div>
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Readers Panel -->
    <div class="panel" id="readers-panel">
      <div class="panel-header">
        <h2 class="panel-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡</h2>
        <button class="btn btn-primary" onclick="showAddReaderModal()">
          + Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
      <div class="loading" id="readers-loading">
        <div class="spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <table id="readers-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="readers-body"></tbody>
      </table>
    </div>

    <!-- Meters Panel -->
    <div class="panel" id="meters-panel">
      <div class="panel-header">
        <h2 class="panel-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
        <div class="actions">
          <button class="btn btn-danger" onclick="deleteAllMeters()">
            Ø­Ø°Ù Ø§Ù„ÙƒÙ„
          </button>
          <button class="btn btn-primary" onclick="showAddMeterModal()">
            + Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
          </button>
        </div>
      </div>
      <div class="filters-row">
        <div class="filter-group">
          <label>Ø§Ù„Ø¨Ø­Ø«</label>
          <input type="text" id="meters-search" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." oninput="filterMeters()">
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
          <select id="reader-filter" onchange="filterMeters()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„ØµÙ†Ù</label>
          <select id="meters-category-filter" onchange="filterMeters()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</option>
            <option value="Ø³ÙƒÙ†ÙŠ">Ø³ÙƒÙ†ÙŠ</option>
            <option value="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</option>
            <option value="ØµÙ†Ø§Ø¹ÙŠ">ØµÙ†Ø§Ø¹ÙŠ</option>
            <option value="Ø­ÙƒÙˆÙ…ÙŠ">Ø­ÙƒÙˆÙ…ÙŠ</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="meters-status-filter" onchange="filterMeters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="read">ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</option>
            <option value="unread">Ù„Ù… ØªØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ø¯ÙŠÙˆÙ†</label>
          <select id="meters-debts-filter" onchange="filterMeters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="has">Ø¨Ø¯ÙŠÙˆÙ†</option>
            <option value="none">Ø¨Ø¯ÙˆÙ† Ø¯ÙŠÙˆÙ†</option>
          </select>
        </div>
        <button class="btn-reset-filters" onclick="resetMetersFilters()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
             
      <div class="results-count" id="meters-count"></div>
      <!-- Bulk Assignment Section -->
      <div class="filters-row" style="background: #e8f4fd; border: 1px solid #bee5eb;">
        <div class="filter-group" style="flex: 1;">
          <label>Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
          <select id="bulk-assign-reader" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø±Ø¦</option>
          </select>
        </div>
        <div class="filter-group" style="flex: 1;">
          <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ¹ÙŠÙŠÙ†</label>
          <select id="bulk-assign-type" onchange="toggleBulkAssignFields()">
            <option value="accountRange">Ù†Ø·Ø§Ù‚ Ø­Ø³Ø§Ø¨Ø§Øª</option>
            <option value="block">Ø¨Ù„ÙˆÙƒ</option>
            <option value="record">Ø³Ø¬Ù„</option>
            <option value="category">Ø§Ù„ØµÙ†Ù</option>
          </select>
        </div>
        <div class="filter-group" id="bulk-assign-range-fields">
          <label>Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input type="text" id="bulk-assign-start" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">
        </div>
        <div class="filter-group" id="bulk-assign-end-field" style="display: none;">
          <label>Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input type="text" id="bulk-assign-end" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ">
        </div>
        <div class="filter-group" id="bulk-assign-single-field" style="display: none;">
          <label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
          <input type="text" id="bulk-assign-value" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„Ø¨Ù„ÙˆÙƒ/Ø§Ù„Ø³Ø¬Ù„/Ø§Ù„ØµÙ†Ù)">
        </div>
        <button class="btn btn-success" onclick="bulkAssignMeters()" style="align-self: flex-end; height: fit-content;">
          ØªØ¹ÙŠÙŠÙ† Ø¬Ù…Ø§Ø¹ÙŠ
        </button>
      </div>
      <div class="results-count" id="meters-count"></div>
      <div class="loading" id="meters-loading">
        <div class="spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <table id="meters-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="accountNumber">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
            <th class="sortable" data-sort="sequence">Ø§Ù„ØªØ³Ù„Ø³Ù„</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</th>
            <th class="sortable" data-sort="subscriberName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th class="sortable" data-sort="category">Ø§Ù„ØµÙ†Ù</th>
            <th class="sortable" data-sort="previousReading">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</th>
            <th class="sortable" data-sort="previousReadingDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
            <th class="sortable" data-sort="currentAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
            <th class="sortable" data-sort="debts">Ø§Ù„Ø¯ÙŠÙˆÙ†</th>
            <th class="sortable" data-sort="totalAmount">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
            <th>Ø§Ù„Ù‚Ø§Ø±Ø¦</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="meters-body"></tbody>
      </table>
    </div>

    <!-- Readings Panel -->
    <div class="panel" id="readings-panel">
      <div class="panel-header">
        <h2 class="panel-title">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
        <div class="actions">
          <button class="btn btn-danger" onclick="deleteAllReadings()">
            Ø­Ø°Ù Ø§Ù„ÙƒÙ„
          </button>
        </div>
      </div>
      <div class="filters-row">

        <div class="filter-group">
          <label>Ø§Ù„Ø¨Ø­Ø«</label>
          <input type="text" id="readings-search" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." oninput="filterReadings()">
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
          <select id="readings-reader-filter" onchange="filterReadings()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="readings-type-filter" onchange="filterReadings()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="reading">Ù‚Ø±Ø§Ø¡Ø§Øª</option>
            <option value="skipped">ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„ØµÙˆØ±Ø©</label>
          <select id="readings-photo-filter" onchange="filterReadings()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="has">Ù…ØªÙˆÙØ±Ø©</option>
            <option value="none">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <select id="readings-location-filter" onchange="filterReadings()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="has">Ù…ØªÙˆÙØ±</option>
            <option value="none">ØºÙŠØ± Ù…ØªÙˆÙØ±</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="readings-month-filter" onchange="loadReadingsByMonth()">
            <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="readings-date-from" onchange="filterReadings()">
        </div>
        <div class="filter-group">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="readings-date-to" onchange="filterReadings()">
        </div>
        <button class="btn-reset-filters" onclick="resetReadingsFilters()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
      <div class="results-count" id="readings-count"></div>
      <div class="loading" id="readings-loading">
        <div class="spinner"></div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
      <table id="readings-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="accountNumber">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
            <th class="sortable" data-sort="subscriberName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ</th>
            <th class="sortable" data-sort="readerName">Ø§Ù„Ù‚Ø§Ø±Ø¦</th>
            <th class="sortable" data-sort="previousReading">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</th>
            <th class="sortable" data-sort="newReading">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</th>
            <th class="sortable" data-sort="difference">Ø§Ù„ÙØ±Ù‚</th>
            <th>Ø³Ø¨Ø¨ Ø§Ù„ØªØ®Ø·ÙŠ</th>
            <th class="sortable" data-sort="readingDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
            <th>Ø§Ù„ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="readings-body"></tbody>
      </table>
    </div>

    <!-- Edit Reading Modal -->
    <div class="modal" id="edit-reading-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h3>
          <button class="modal-close" onclick="closeEditReadingModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-reading-id">
          <div class="form-group">
            <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input type="number" id="edit-reading-value" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">
          </div>
          <div class="form-group">
            <label>Ø³Ø¨Ø¨ Ø§Ù„ØªØ®Ø·ÙŠ</label>
            <input type="text" id="edit-reading-skip-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØ®Ø·ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="edit-reading-notes" rows="3" placeholder="Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeEditReadingModal()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn btn-primary" onclick="saveReadingEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
      </div>
    </div>

    <!-- Import Panel -->
    <div class="panel" id="import-panel">
      <div class="panel-header">
        <h2 class="panel-title">Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
      </div>
      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
        <select id="import-type">
          <option value="meters">Ø¹Ø¯Ø§Ø¯Ø§Øª</option>
          <option value="readers">Ù‚Ø±Ø§Ø¡</option>
        </select>
      </div>
      <div class="upload-area" onclick="document.getElementById('import-file').click()">
        <input type="file" id="import-file" accept=".json,.csv,.xlsx,.xls,.mdb,.accdb" onchange="handleFileSelect(event)">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§</div>
        <div class="upload-hint">ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª JSON Ùˆ CSV Ùˆ Excel</div>
      </div>
      <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="downloadTemplate('readers')">
          ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø¡
        </button>
        <button class="btn btn-secondary" onclick="downloadTemplate('meters')">
          ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
        </button>
      </div>
      <div id="import-preview" style="margin-top: 20px; display: none;">
        <h3 style="margin-bottom: 15px;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div id="preview-content"></div>
        <button class="btn btn-success" onclick="confirmImport()" style="margin-top: 15px;">
          ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¹
        </button>
      </div>
    </div>

    <!-- Export Panel -->
    <div class="panel" id="export-panel">
      <div class="panel-header">
        <h2 class="panel-title">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <select id="export-type">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
            <option value="readers">Ø§Ù„Ù‚Ø±Ø§Ø¡ ÙÙ‚Ø·</option>
            <option value="meters">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø·</option>
            <option value="readings">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª ÙÙ‚Ø·</option>
          </select>
        </div>
        <div class="form-group">
          <label>ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù</label>
          <select id="export-format">
            <option value="excel">Excel (Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù‚Ø§Ø±Ø¦ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <select id="export-reader">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="exportData()">
        ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      </button>
    </div>
  </div>

  <!-- Add Reader Modal -->
  <div class="modal" id="reader-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="reader-modal-title">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯</h3>
        <button class="modal-close" onclick="closeModal('reader-modal')">&times;</button>
      </div>
      <form id="reader-form" onsubmit="saveReader(event)">
        <input type="hidden" id="reader-id">
        <div class="form-group">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input type="text" id="reader-username" required>
        </div>
        <div class="form-group">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input type="password" id="reader-password" autocomplete="new-password">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</label>
          <input type="text" id="reader-displayName" required>
        </div>
        <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
      </form>
    </div>
  </div>

  <!-- Add Meter Modal -->
  <div class="modal" id="meter-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="meter-modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
        <button class="modal-close" onclick="closeModal('meter-modal')">&times;</button>
      </div>
      <form id="meter-form" onsubmit="saveMeter(event)">
        <input type="hidden" id="meter-id">
        <div class="form-row">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="text" id="meter-accountNumber" required>
          </div>
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</label>
            <input type="text" id="meter-meterNumber" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„ØªØ³Ù„Ø³Ù„</label>
            <input type="text" id="meter-sequence" required>
          </div>
          <div class="form-group">
            <label>Ø§Ù„ØµÙ†Ù</label>
            <select id="meter-category" required>
              <option value="Ø³ÙƒÙ†ÙŠ">Ø³ÙƒÙ†ÙŠ</option>
              <option value="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</option>
              <option value="ØµÙ†Ø§Ø¹ÙŠ">ØµÙ†Ø§Ø¹ÙŠ</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ</label>
          <input type="text" id="meter-subscriberName" required>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input type="text" id="meter-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ø³Ø¬Ù„</label>
            <input type="text" id="meter-record" required>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø¨Ù„ÙˆÙƒ</label>
            <input type="text" id="meter-block" required>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
            <input type="text" id="meter-property" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</label>
            <input type="number" id="meter-previousReading" required>
          </div>
          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</label>
            <input type="date" id="meter-previousReadingDate" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
            <input type="number" id="meter-currentAmount" required>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø¯ÙŠÙˆÙ†</label>
            <input type="number" id="meter-debts" value="0">
          </div>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
          <select id="meter-readerId" required></select>
        </div>
        <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
      </form>
    </div>
  </div>

  <!-- Meter Details Modal -->
  <div class="modal" id="meter-details-modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</h3>
        <button class="modal-close" onclick="closeModal('meter-details-modal')">&times;</button>
      </div>
      <div id="meter-details-content"></div>
    </div>
  </div>

  <script>
    let readers = [];
    let meters = [];
    let allReadings = [];
    let importData = null;
    let categoryMapping = {};
    let charts = {
      categories: null,
      status: null,
      performance: null
    };

    async function deleteAllReadings() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/readings-all', {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          loadReadings();
          updateStats();
        } else {
          showAlert('error', 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error deleting readings:', error);
        showAlert('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª');
      }
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        const panelId = tab.dataset.tab + '-panel';
        const panel = document.getElementById(panelId);
        if (panel) panel.classList.add('active');
        
        if (tab.dataset.tab === 'dashboard') {
          loadDashboardStats();
        }
      });
    });

    async function loadData() {
      populateMonthFilter();
      await Promise.all([
        loadReaders(), 
        loadMeters(), 
        loadReadings(),
        loadDashboardStats()
      ]);
      updateCategoryFilters();
      renderMeters();
      renderReadings();
      updateStats();
      toggleBulkAssignFields(); // Initialize bulk assignment fields after data loads
    }

    function updateCategoryFilters() {
      const select = document.getElementById('meters-category-filter');
      const uniqueCategoryIds = [...new Set(meters.map(m => m.category).filter(Boolean))];
      uniqueCategoryIds.sort();
      
      let options = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</option>';
      uniqueCategoryIds.forEach(id => {
        const label = categoryMapping[id] || id;
        options += `<option value="${id}">${label}</option>`;
      });
      select.innerHTML = options;
    }

    async function loadDashboardStats() {
      const loading = document.getElementById('stats-loading');
      if (loading) loading.style.display = 'block';
      
      try {
        const response = await fetch('/api/admin/dashboard-stats', {
          credentials: 'include'
        });
        const data = await response.json();
        
        // Update Mappings
        categoryMapping = data.categoryNames || {};
        
        // Update KPIs
        document.getElementById('kpi-completion').textContent = `${data.kpis.completionRate}%`;
        document.getElementById('kpi-completion-bar').style.width = `${data.kpis.completionRate}%`;
        document.getElementById('kpi-amounts').textContent = `${data.kpis.totalCurrentAmount.toLocaleString('ar-IQ')} Ø¯.Ø¹`;
        document.getElementById('kpi-debts').textContent = `${data.kpis.totalDebts.toLocaleString('ar-IQ')} Ø¯.Ø¹`;
        document.getElementById('kpi-ratio').textContent = `${data.kpis.collectionRatio}%`;
        
        // Update Header Stats
        document.getElementById('totalReaders').textContent = data.counts.readers;
        document.getElementById('totalMeters').textContent = data.counts.meters;
        document.getElementById('totalReadings').textContent = data.counts.readings;
        
        // Update Charts
        renderCategoriesChart(data.charts.categories);
        renderStatusChart(data.charts.statusBreakdown);
        renderPerformanceChart(data.charts.readerPerformance);
        
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }

    function renderCategoriesChart(categoryData) {
      const ctx = document.getElementById('categoriesChart').getContext('2d');
      if (charts.categories) charts.categories.destroy();
      
      const labels = Object.keys(categoryData).map(id => categoryMapping[id] || id);
      const values = Object.values(categoryData);
      
      charts.categories = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: [
              '#1e5799', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { font: { family: 'Cairo' } } }
          }
        }
      });
    }

    function renderStatusChart(statusData) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (charts.status) charts.status.destroy();
      
      charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù…ØªØ®Ø·Ø§Ø©'],
          datasets: [{
            data: [statusData.completed, statusData.skipped],
            backgroundColor: ['#28a745', '#ffc107']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { font: { family: 'Cairo' } } }
          }
        }
      });
    }

    function renderPerformanceChart(performanceData) {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      if (charts.performance) charts.performance.destroy();
      
      charts.performance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(performanceData),
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª',
            data: Object.values(performanceData),
            backgroundColor: '#1e5799'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    async function loadReaders() {
      document.getElementById('readers-loading').classList.add('show');
      try {
        const response = await fetch('/api/admin/readers', {
          credentials: 'include'
        });
        readers = await response.json();
        renderReaders();
        updateReaderSelects();
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡');
      }
      document.getElementById('readers-loading').classList.remove('show');
    }

    async function loadMeters() {
      document.getElementById('meters-loading').classList.add('show');
      try {
        const response = await fetch('/api/admin/meters', {
          credentials: 'include'
        });
        meters = await response.json();
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†');
      }
      document.getElementById('meters-loading').classList.remove('show');
    }

    async function loadReadings() {
      document.getElementById('readings-loading').classList.add('show');
      try {
        const response = await fetch('/api/admin/readings', {
          credentials: 'include'
        });
        allReadings = await response.json();
        renderReadings();
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª');
      }
      document.getElementById('readings-loading').classList.remove('show');
    }

    function renderReaders() {
      const tbody = document.getElementById('readers-body');
      tbody.innerHTML = readers.map(reader => `
        <tr>
          <td>${reader.id.slice(0, 8)}...</td>
          <td>${reader.username}</td>
          <td>${reader.displayName}</td>
          <td>${reader.meterCount || 0}</td>
          <td class="actions">
            <button class="btn btn-sm btn-secondary" onclick="editReader('${reader.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-sm btn-danger" onclick="deleteReader('${reader.id}')">Ø­Ø°Ù</button>
          </td>
        </tr>
      `).join('');
    }

    function renderMeters() {
      const tbody = document.getElementById('meters-body');
      const filteredMeters = filterMetersData();
      tbody.innerHTML = filteredMeters.map(meter => {
        const reader = readers.find(r => r.id === meter.readerId);
        const hasReading = meter.latestReading !== null;
        const prevDate = meter.previousReadingDate ? new Date(meter.previousReadingDate).toLocaleDateString('ar-IQ') : '-';
        const currentAmount = parseFloat(meter.currentAmount || 0).toLocaleString('ar-IQ');
        const debts = parseFloat(meter.debts || 0).toLocaleString('ar-IQ');
        const totalAmount = parseFloat(meter.totalAmount || 0).toLocaleString('ar-IQ');
        return `
          <tr>
            <td>${meter.accountNumber}</td>
            <td>${meter.sequence}</td>
            <td>${meter.meterNumber}</td>
            <td>${meter.subscriberName}</td>
            <td>${meter.address || '-'}</td>
            <td>${categoryMapping[meter.category] || meter.category}</td>
            <td>${meter.previousReading?.toLocaleString('ar-IQ') || '-'}</td>
            <td>${prevDate}</td>
            <td>${currentAmount} Ø¯.Ø¹</td>
            <td style="color: ${parseFloat(meter.debts || 0) > 0 ? '#dc3545' : 'inherit'}">${debts} Ø¯.Ø¹</td>
            <td style="font-weight: bold; color: #1e5799">${totalAmount} Ø¯.Ø¹</td>
            <td>${reader?.displayName || '-'}</td>
            <td><span class="badge ${hasReading ? 'badge-success' : 'badge-warning'}">${hasReading ? 'ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©' : 'Ù„Ù… ØªØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'}</span></td>
            <td class="actions">
              <button class="btn btn-sm btn-primary" onclick="viewMeterDetails('${meter.id}')">Ø¹Ø±Ø¶</button>
              <button class="btn btn-sm btn-secondary" onclick="editMeter('${meter.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-sm btn-danger" onclick="deleteMeter('${meter.id}')">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderReadings() {
      const tbody = document.getElementById('readings-body');
      const filteredReadings = filterReadingsData();
      tbody.innerHTML = filteredReadings.map(reading => {
        const meter = meters.find(m => m.id === reading.meterId);
        const reader = readers.find(r => r.id === reading.readerId);
        const readingDate = reading.readingDate ? new Date(reading.readingDate).toLocaleDateString('ar-IQ') : new Date(reading.createdAt).toLocaleDateString('ar-IQ');
        const readingTime = reading.readingDate ? new Date(reading.readingDate).toLocaleTimeString('ar-IQ', {hour: '2-digit', minute: '2-digit'}) : '';
        const hasLocation = reading.latitude && reading.longitude;
        const locationLink = hasLocation ? 
          `<a href="https://www.google.com/maps?q=${reading.latitude},${reading.longitude}" target="_blank" style="color: #1e5799;">Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>` : 
          '-';
        const prevReading = meter?.previousReading || 0;
        const newReading = reading.newReading || 0;
        const difference = reading.newReading !== null ? (newReading - prevReading) : '-';
        const photoLink = reading.photoPath ? 
          `<a href="/api/photo/${reading.photoPath}" target="_blank" class="photo-link" title="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©">
            <span class="badge badge-success">Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</span>
          </a>` : 
          `<span class="badge badge-warning">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>`;
        return `
          <tr>
            <td>${meter?.accountNumber || '-'}</td>
            <td>${meter?.subscriberName || '-'}</td>
            <td>${reader?.displayName || '-'}</td>
            <td>${meter?.previousReading?.toLocaleString('ar-IQ') || '-'}</td>
            <td style="font-weight: bold; color: #28a745">${reading.newReading !== null ? reading.newReading.toLocaleString('ar-IQ') : '-'}</td>
            <td style="color: ${difference > 0 ? '#1e5799' : '#dc3545'}">${typeof difference === 'number' ? difference.toLocaleString('ar-IQ') : difference}</td>
            <td>${reading.skipReason ? `<span class="badge badge-warning">${reading.skipReason}</span>` : '-'}</td>
            <td>${readingDate} ${readingTime}</td>
            <td>${locationLink}</td>
            <td>${photoLink}</td>
            <td>${reading.notes || '-'}</td>
            <td class="actions">
              <button class="btn btn-sm btn-secondary" onclick="editReading('${reading.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-sm btn-danger" onclick="deleteReading('${reading.id}')">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    let metersSortField = 'sequence';
    let metersSortDir = 'asc';
    let readingsSortField = 'readingDate';
    let readingsSortDir = 'desc';

    function filterMetersData() {
      const search = document.getElementById('meters-search').value.toLowerCase();
      const readerId = document.getElementById('reader-filter').value;
      const category = document.getElementById('meters-category-filter').value;
      const status = document.getElementById('meters-status-filter').value;
      const debtsFilter = document.getElementById('meters-debts-filter').value;
      
      let filtered = meters.filter(m => {
        const matchesSearch = !search || 
          m.accountNumber.toLowerCase().includes(search) ||
          m.subscriberName.toLowerCase().includes(search);
        const matchesReader = !readerId || m.readerId === readerId;
        const matchesCategory = !category || m.category === category;
        const hasReading = m.latestReading !== null;
        const matchesStatus = !status || 
          (status === 'read' && hasReading) || 
          (status === 'unread' && !hasReading);
        const hasDebts = parseFloat(m.debts || 0) > 0;
        const matchesDebts = !debtsFilter || 
          (debtsFilter === 'has' && hasDebts) || 
          (debtsFilter === 'none' && !hasDebts);
        return matchesSearch && matchesReader && matchesCategory && matchesStatus && matchesDebts;
      });
      
      filtered.sort((a, b) => {
        let valA = a[metersSortField];
        let valB = b[metersSortField];
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';
        if (valA < valB) return metersSortDir === 'asc' ? -1 : 1;
        if (valA > valB) return metersSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      document.getElementById('meters-count').textContent = `Ø¹Ø±Ø¶ ${filtered.length} Ù…Ù† ${meters.length} Ù…Ø´ØªØ±Ùƒ`;
      return filtered;
    }

    function filterReadingsData() {
      const search = document.getElementById('readings-search').value.toLowerCase();
      const readerId = document.getElementById('readings-reader-filter').value;
      const typeFilter = document.getElementById('readings-type-filter').value;
      const photoFilter = document.getElementById('readings-photo-filter').value;
      const locationFilter = document.getElementById('readings-location-filter').value;
      const dateFrom = document.getElementById('readings-date-from').value;
      const dateTo = document.getElementById('readings-date-to').value;
      
      let filtered = allReadings.filter(r => {
        const meter = meters.find(m => m.id === r.meterId);
        const matchesSearch = !search || 
          meter?.accountNumber.toLowerCase().includes(search) ||
          meter?.subscriberName.toLowerCase().includes(search);
        const matchesReader = !readerId || r.readerId === readerId;
        const isSkipped = r.skipReason !== null && r.skipReason !== '';
        const matchesType = !typeFilter || 
          (typeFilter === 'reading' && !isSkipped) || 
          (typeFilter === 'skipped' && isSkipped);
        const hasPhoto = r.photoPath !== null && r.photoPath !== '';
        const matchesPhoto = !photoFilter || 
          (photoFilter === 'has' && hasPhoto) || 
          (photoFilter === 'none' && !hasPhoto);
        const hasLocation = r.latitude !== null && r.longitude !== null;
        const matchesLocation = !locationFilter || 
          (locationFilter === 'has' && hasLocation) || 
          (locationFilter === 'none' && !hasLocation);
        const readingDate = new Date(r.readingDate || r.createdAt);
        const matchesDateFrom = !dateFrom || readingDate >= new Date(dateFrom);
        const matchesDateTo = !dateTo || readingDate <= new Date(dateTo + 'T23:59:59');
        return matchesSearch && matchesReader && matchesType && matchesPhoto && matchesLocation && matchesDateFrom && matchesDateTo;
      });
      
      filtered.sort((a, b) => {
        const meterA = meters.find(m => m.id === a.meterId);
        const meterB = meters.find(m => m.id === b.meterId);
        const readerA = readers.find(r => r.id === a.readerId);
        const readerB = readers.find(r => r.id === b.readerId);
        
        let valA, valB;
        switch(readingsSortField) {
          case 'accountNumber': valA = meterA?.accountNumber || ''; valB = meterB?.accountNumber || ''; break;
          case 'subscriberName': valA = meterA?.subscriberName || ''; valB = meterB?.subscriberName || ''; break;
          case 'readerName': valA = readerA?.displayName || ''; valB = readerB?.displayName || ''; break;
          case 'previousReading': valA = meterA?.previousReading || 0; valB = meterB?.previousReading || 0; break;
          case 'newReading': valA = a.newReading || 0; valB = b.newReading || 0; break;
          case 'difference': 
            valA = a.newReading !== null ? (a.newReading - (meterA?.previousReading || 0)) : 0;
            valB = b.newReading !== null ? (b.newReading - (meterB?.previousReading || 0)) : 0;
            break;
          case 'readingDate': valA = new Date(a.readingDate || a.createdAt); valB = new Date(b.readingDate || b.createdAt); break;
          default: valA = a[readingsSortField]; valB = b[readingsSortField];
        }
        
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (valA < valB) return readingsSortDir === 'asc' ? -1 : 1;
        if (valA > valB) return readingsSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      document.getElementById('readings-count').textContent = `Ø¹Ø±Ø¶ ${filtered.length} Ù…Ù† ${allReadings.length} Ù‚Ø±Ø§Ø¡Ø©`;
      return filtered;
    }

    function filterMeters() { renderMeters(); }
    function filterReadings() { renderReadings(); }
    
    function resetMetersFilters() {
      document.getElementById('meters-search').value = '';
      document.getElementById('reader-filter').value = '';
      document.getElementById('meters-category-filter').value = '';
      document.getElementById('meters-status-filter').value = '';
      document.getElementById('meters-debts-filter').value = '';
      metersSortField = 'sequence';
      metersSortDir = 'asc';
      updateSortIndicators('meters-table', metersSortField, metersSortDir);
      renderMeters();
    }
    
    function resetReadingsFilters() {
      document.getElementById('readings-search').value = '';
      document.getElementById('readings-reader-filter').value = '';
      document.getElementById('readings-type-filter').value = '';
      document.getElementById('readings-photo-filter').value = '';
      document.getElementById('readings-location-filter').value = '';
      document.getElementById('readings-month-filter').value = '';
      document.getElementById('readings-date-from').value = '';
      document.getElementById('readings-date-to').value = '';
      readingsSortField = 'readingDate';
      readingsSortDir = 'desc';
      updateSortIndicators('readings-table', readingsSortField, readingsSortDir);
      loadReadings();
    }
    
    function updateSortIndicators(tableId, field, dir) {
      const table = document.getElementById(tableId);
      table.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === field) {
          th.classList.add(dir);
        }
      });
    }
    
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('sortable')) {
        const field = e.target.dataset.sort;
        const table = e.target.closest('table');
        
        if (table.id === 'meters-table') {
          if (metersSortField === field) {
            metersSortDir = metersSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            metersSortField = field;
            metersSortDir = 'asc';
          }
          updateSortIndicators('meters-table', metersSortField, metersSortDir);
          renderMeters();
        } else if (table.id === 'readings-table') {
          if (readingsSortField === field) {
            readingsSortDir = readingsSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            readingsSortField = field;
            readingsSortDir = 'asc';
          }
          updateSortIndicators('readings-table', readingsSortField, readingsSortDir);
          renderReadings();
        }
      }
    });

    function updateReaderSelects() {
      const options = readers.map(r => `<option value="${r.id}">${r.displayName}</option>`).join('');
      document.getElementById('reader-filter').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>' + options;
      document.getElementById('readings-reader-filter').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>' + options;
      document.getElementById('export-reader').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</option>' + options;
      document.getElementById('meter-readerId').innerHTML = options;
      document.getElementById('bulk-assign-reader').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø±Ø¦</option>' + options;
    }
    
    function toggleBulkAssignFields() {
      const type = document.getElementById('bulk-assign-type').value;
      const rangeFields = document.getElementById('bulk-assign-range-fields');
      const endField = document.getElementById('bulk-assign-end-field');
      const singleField = document.getElementById('bulk-assign-single-field');
      
      // Hide all fields initially
      endField.style.display = 'none';
      singleField.style.display = 'none';
      rangeFields.style.display = 'none';
      
      if (type === 'accountRange') {
        // Show both start and end fields for account range
        rangeFields.style.display = 'block';
        endField.style.display = 'block';
      } else {
        // Show single field for block, record, or category
        singleField.style.display = 'block';
      }
    }
    
    async function bulkAssignMeters() {
      const readerId = document.getElementById('bulk-assign-reader').value;
      const type = document.getElementById('bulk-assign-type').value;
      
      if (!readerId) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦');
        return;
      }
      
      let filterValue = '';
      let filterValueEnd = '';
      
      if (type === 'accountRange') {
        filterValue = document.getElementById('bulk-assign-start').value;
        filterValueEnd = document.getElementById('bulk-assign-end').value;
        
        if (!filterValue || !filterValueEnd) {
          showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
          return;
        }
      } else {
        filterValue = document.getElementById('bulk-assign-value').value;
        if (!filterValue) {
          showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©');
          return;
        }
      }
      
      try {
        const response = await fetch('/api/admin/meters/bulk-assign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            readerId,
            filterType: type,
            filterValue,
            filterValueEnd
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showSuccess(`ØªÙ… ØªØ¹ÙŠÙŠÙ† ${result.count} Ù…Ø´ØªØ±Ùƒ/Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­`);
          loadMeters(); // Refresh the meters list
        } else {
          showError(result.error || 'ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†');
        }
      } catch (error) {
        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    }
    
    // Initialize bulk assignment fields when page loads
    document.addEventListener('DOMContentLoaded', function() {
      toggleBulkAssignFields(); // Set initial visibility
    });

    function updateStats() {
      document.getElementById('totalReaders').textContent = readers.length;
      document.getElementById('totalMeters').textContent = meters.length;
      document.getElementById('totalReadings').textContent = allReadings.length;
    }

    function showAddReaderModal() {
      document.getElementById('reader-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯';
      document.getElementById('reader-form').reset();
      document.getElementById('reader-id').value = '';
      document.getElementById('reader-modal').classList.add('active');
    }

    function editReader(id) {
      const reader = readers.find(r => r.id === id);
      if (!reader) return;
      document.getElementById('reader-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦';
      document.getElementById('reader-id').value = reader.id;
      document.getElementById('reader-username').value = reader.username;
      document.getElementById('reader-displayName').value = reader.displayName;
      document.getElementById('reader-password').value = '';
      document.getElementById('reader-modal').classList.add('active');
    }

    async function saveReader(event) {
      event.preventDefault();
      const id = document.getElementById('reader-id').value;
      const data = {
        username: document.getElementById('reader-username').value,
        displayName: document.getElementById('reader-displayName').value,
      };
      const password = document.getElementById('reader-password').value;
      if (password) data.password = password;

      try {
        const url = id ? `/api/admin/readers/${id}` : '/api/admin/readers';
        const method = id ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error();
        showSuccess(id ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø±Ø¦' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦');
        closeModal('reader-modal');
        loadReaders();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø±Ø¦');
      }
    }

    async function deleteReader(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ø±Ø¦ØŸ')) return;
      try {
        const response = await fetch(`/api/admin/readers/${id}`, { 
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø±Ø¦');
        loadReaders();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø±Ø¦');
      }
    }

    function showAddMeterModal() {
      document.getElementById('meter-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯';
      document.getElementById('meter-form').reset();
      document.getElementById('meter-id').value = '';
      document.getElementById('meter-modal').classList.add('active');
    }

    function editMeter(id) {
      const meter = meters.find(m => m.id === id);
      if (!meter) return;
      document.getElementById('meter-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯';
      document.getElementById('meter-id').value = meter.id;
      document.getElementById('meter-accountNumber').value = meter.accountNumber;
      document.getElementById('meter-meterNumber').value = meter.meterNumber;
      document.getElementById('meter-sequence').value = meter.sequence;
      document.getElementById('meter-category').value = meter.category;
      document.getElementById('meter-subscriberName').value = meter.subscriberName;
      document.getElementById('meter-address').value = meter.address || '';
      document.getElementById('meter-record').value = meter.record;
      document.getElementById('meter-block').value = meter.block;
      document.getElementById('meter-property').value = meter.property;
      document.getElementById('meter-previousReading').value = meter.previousReading;
      document.getElementById('meter-previousReadingDate').value = meter.previousReadingDate ? new Date(meter.previousReadingDate).toISOString().split('T')[0] : '';
      document.getElementById('meter-currentAmount').value = meter.currentAmount;
      document.getElementById('meter-debts').value = meter.debts || 0;
      document.getElementById('meter-readerId').value = meter.readerId;
      document.getElementById('meter-modal').classList.add('active');
    }

    async function saveMeter(event) {
      event.preventDefault();
      const id = document.getElementById('meter-id').value;
      const currentAmount = document.getElementById('meter-currentAmount').value;
      const debts = document.getElementById('meter-debts').value || '0';
      const data = {
        accountNumber: document.getElementById('meter-accountNumber').value,
        meterNumber: document.getElementById('meter-meterNumber').value,
        sequence: document.getElementById('meter-sequence').value,
        category: document.getElementById('meter-category').value,
        subscriberName: document.getElementById('meter-subscriberName').value,
        address: document.getElementById('meter-address').value || '',
        record: document.getElementById('meter-record').value,
        block: document.getElementById('meter-block').value,
        property: document.getElementById('meter-property').value,
        previousReading: parseInt(document.getElementById('meter-previousReading').value),
        previousReadingDate: document.getElementById('meter-previousReadingDate').value || null,
        currentAmount: currentAmount,
        debts: debts,
        totalAmount: (parseFloat(currentAmount) + parseFloat(debts)).toString(),
        readerId: document.getElementById('meter-readerId').value,
      };

      try {
        const url = id ? `/api/admin/meters/${id}` : '/api/admin/meters';
        const method = id ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error();
        showSuccess(id ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ø§Ø¯');
        closeModal('meter-modal');
        loadMeters();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯');
      }
    }

    async function deleteMeter(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ')) return;
      try {
        const response = await fetch(`/api/admin/meters/${id}`, { 
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯');
        loadMeters();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯');
      }
    }

    async function deleteAllMeters() {
      if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ù…!\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) return;
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')) return;
      
      try {
        const response = await fetch('/api/admin/meters-all', { 
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
        await loadData();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†');
      }
    }

    function editReading(id) {
      const reading = allReadings.find(r => r.id === id);
      if (!reading) return;
      
      document.getElementById('edit-reading-id').value = id;
      document.getElementById('edit-reading-value').value = reading.newReading || '';
      document.getElementById('edit-reading-skip-reason').value = reading.skipReason || '';
      document.getElementById('edit-reading-notes').value = reading.notes || '';
      
      document.getElementById('edit-reading-modal').classList.add('active');
    }

    function closeEditReadingModal() {
      document.getElementById('edit-reading-modal').classList.remove('active');
    }

    async function saveReadingEdit() {
      const id = document.getElementById('edit-reading-id').value;
      const newReading = document.getElementById('edit-reading-value').value;
      const skipReason = document.getElementById('edit-reading-skip-reason').value;
      const notes = document.getElementById('edit-reading-notes').value;
      
      try {
        const response = await fetch(`/api/admin/readings/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            newReading: newReading ? parseInt(newReading) : null,
            skipReason: skipReason || null,
            notes: notes || null,
          })
        });
        if (!response.ok) throw new Error();
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
        closeEditReadingModal();
        loadReadings();
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
      }
    }

    async function deleteReading(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ')) return;
      try {
        const response = await fetch(`/api/admin/readings/${id}`, { 
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
        loadReadings();
      } catch (error) {
        showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
      }
    }

    function populateMonthFilter() {
      const select = document.getElementById('readings-month-filter');
      const months = [
        'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
        'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
      ];
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;
      
      select.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>';
      for (let y = currentYear; y >= currentYear - 2; y--) {
        const maxMonth = (y === currentYear) ? currentMonth : 12;
        for (let m = maxMonth; m >= 1; m--) {
          select.innerHTML += `<option value="${y}-${m}">${months[m-1]} ${y}</option>`;
        }
      }
    }

    async function loadReadingsByMonth() {
      const filter = document.getElementById('readings-month-filter').value;
      if (!filter) {
        loadReadings();
        return;
      }
      
      const [year, month] = filter.split('-');
      document.getElementById('readings-loading').style.display = 'block';
      
      try {
        const response = await fetch(`/api/admin/readings?year=${year}&month=${month}`, {
          credentials: 'include'
        });
        allReadings = await response.json();
        renderReadings();
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª');
      } finally {
        document.getElementById('readings-loading').style.display = 'none';
      }
    }

    function viewMeterDetails(id) {
      const meter = meters.find(m => m.id === id);
      if (!meter) return;
      
      const reader = readers.find(r => r.id === meter.readerId);
      const meterReadings = allReadings.filter(r => r.meterId === id);
      const prevDate = meter.previousReadingDate ? new Date(meter.previousReadingDate).toLocaleDateString('ar-IQ') : '-';
      
      let readingsHtml = '';
      if (meterReadings.length > 0) {
        readingsHtml = `
          <h4 style="margin: 20px 0 10px; color: #1a1a2e;">Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª (${meterReadings.length})</h4>
          <table style="width: 100%; font-size: 14px;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 8px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="padding: 8px;">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
                <th style="padding: 8px;">Ø³Ø¨Ø¨ Ø§Ù„ØªØ®Ø·ÙŠ</th>
                <th style="padding: 8px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                <th style="padding: 8px;">Ø§Ù„ØµÙˆØ±Ø©</th>
                <th style="padding: 8px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${meterReadings.map(r => {
                const rDate = r.readingDate ? new Date(r.readingDate).toLocaleDateString('ar-IQ') : new Date(r.createdAt).toLocaleDateString('ar-IQ');
                const rTime = r.readingDate ? new Date(r.readingDate).toLocaleTimeString('ar-IQ', {hour: '2-digit', minute: '2-digit'}) : '';
                const hasLoc = r.latitude && r.longitude;
                const locLink = hasLoc ? 
                  '<a href="https://www.google.com/maps?q=' + r.latitude + ',' + r.longitude + '" target="_blank" style="color: #1e5799;">Ø®Ø±ÙŠØ·Ø©</a>' : '-';
                const photoStatus = r.photoPath ? '<a href="/api/photo/' + r.photoPath + '" target="_blank" class="photo-link"><span class="badge badge-success">Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</span></a>' : '<span class="badge badge-warning">Ù„Ø§</span>';
                return '<tr><td style="padding: 8px;">' + rDate + ' ' + rTime + '</td><td style="padding: 8px; font-weight: bold;">' + (r.newReading !== null ? r.newReading.toLocaleString('ar-IQ') : '-') + '</td><td style="padding: 8px;">' + (r.skipReason || '-') + '</td><td style="padding: 8px;">' + locLink + '</td><td style="padding: 8px;">' + photoStatus + '</td><td style="padding: 8px;">' + (r.notes || '-') + '</td></tr>';
              }).join('')}
            </tbody>
          </table>
        `;
      } else {
        readingsHtml = '<p style="color: #999; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØªØ±Ùƒ</p>';
      }
      
      document.getElementById('meter-details-content').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <h4 style="color: #1e5799; margin-bottom: 15px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 8px; color: #666;">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</td><td style="padding: 8px; font-weight: bold;">${meter.accountNumber}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„ØªØ³Ù„Ø³Ù„:</td><td style="padding: 8px;">${meter.sequence}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</td><td style="padding: 8px; font-weight: bold;">${meter.subscriberName}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚ÙŠØ§Ø³:</td><td style="padding: 8px;">${meter.meterNumber}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„ØµÙ†Ù:</td><td style="padding: 8px;">${meter.category}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td style="padding: 8px;">${meter.address || '-'}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ø³Ø¬Ù„/Ø§Ù„Ø¨Ù„ÙˆÙƒ/Ø§Ù„Ø¹Ù‚Ø§Ø±:</td><td style="padding: 8px;">${meter.record}/${meter.block}/${meter.property}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</td><td style="padding: 8px;">${reader?.displayName || '-'}</td></tr>
            </table>
          </div>
          <div>
            <h4 style="color: #1e5799; margin-bottom: 15px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº</h4>
            <table style="width: 100%;">
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</td><td style="padding: 8px; font-weight: bold; color: #1e5799;">${meter.previousReading?.toLocaleString('ar-IQ') || '-'}</td></tr>
              <tr><td style="padding: 8px; color: #666;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:</td><td style="padding: 8px;">${prevDate}</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ:</td><td style="padding: 8px;">${parseFloat(meter.currentAmount || 0).toLocaleString('ar-IQ')} Ø¯.Ø¹</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ø¯ÙŠÙˆÙ†:</td><td style="padding: 8px; color: #dc3545;">${parseFloat(meter.debts || 0).toLocaleString('ar-IQ')} Ø¯.Ø¹</td></tr>
              <tr><td style="padding: 8px; color: #666; font-weight: bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</td><td style="padding: 8px; font-weight: bold; color: #1e5799; font-size: 18px;">${parseFloat(meter.totalAmount || 0).toLocaleString('ar-IQ')} Ø¯.Ø¹</td></tr>
              <tr><td style="padding: 8px; color: #666;">Ø§Ù„Ø­Ø§Ù„Ø©:</td><td style="padding: 8px;"><span class="badge ${meter.latestReading ? 'badge-success' : 'badge-warning'}">${meter.latestReading ? 'ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©' : 'Ù„Ù… ØªØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'}</span></td></tr>
            </table>
          </div>
        </div>
        ${readingsHtml}
      `;
      document.getElementById('meter-details-modal').classList.add('active');
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.mdb') || file.name.endsWith('.accdb')) {
        // For binary files, we just set a preview and wait for confirmImport
        importData = { binary: true, name: file.name };
        showImportPreview();
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          if (file.name.endsWith('.json')) {
            importData = JSON.parse(content);
          } else if (file.name.endsWith('.csv')) {
            importData = parseCSV(content);
          }
          showImportPreview();
        } catch (error) {
          showError('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(content) {
      const lines = content.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }
    
    async function downloadTemplate(type) {
      try {
        const response = await fetch(`/api/admin/template/${type}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('Failed to download template');
        }
        
        // Create blob from response
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        // Create temporary link and trigger download
        const a = document.createElement('a');
        a.href = url;
        a.download = `template_${type}.xlsx`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨: ' + error.message);
      }
    }

    function showImportPreview() {
      const preview = document.getElementById('import-preview');
      const content = document.getElementById('preview-content');
      if (!importData || importData.length === 0) {
        content.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>';
      } else if (importData.binary) {
        content.innerHTML = `<p>Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹: <b>${importData.name}</b></p>`;
      } else {
        content.innerHTML = `<p>Ø³ÙŠØªÙ… Ø±ÙØ¹ ${importData.length} Ø³Ø¬Ù„</p>`;
      }
      preview.style.display = 'block';
    }

    async function confirmImport() {
      if (!importData) return;
      const btn = event?.target || document.querySelector('#import-preview .btn-success');
      const originalText = btn.textContent;
      
      console.log("Starting import process...", { type: document.getElementById('import-type').value, importData });
      
      try {
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
        
        const type = document.getElementById('import-type').value;
      
      // Get the selected file
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];
      
      if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.mdb') || file.name.endsWith('.accdb'))) {
        // Upload Binary file using FormData
        const formData = new FormData();
        formData.append('file', file);
        
        let endpoint = '';
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          endpoint = `/api/admin/import-excel/${type}`;
        } else {
          endpoint = `/api/admin/import-access/${type}`;
        }
        
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });
          
          if (!response.ok) {
            const errorResult = await response.json();
            throw new Error(errorResult.error || 'Upload failed');
          }
          
          const result = await response.json();
          showSuccess(`ØªÙ… Ø±ÙØ¹ ${result.count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`);
          document.getElementById('import-preview').style.display = 'none';
          importData = null;
          fileInput.value = ''; // Reset file input
          loadData();
        } catch (error) {
          showError('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);
        }
      } else {
        // Handle JSON/CSV data
        try {
          const response = await fetch(`/api/admin/import/${type}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(importData)
          });
          if (!response.ok) throw new Error();
          const result = await response.json();
          showSuccess(`ØªÙ… Ø±ÙØ¹ ${result.count} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`);
          document.getElementById('import-preview').style.display = 'none';
          importData = null;
          fileInput.value = ''; // Reset file input
          loadData();
        } catch (error) {
          console.error("JSON/CSV Import error:", error);
          showError('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        }
        }
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function exportData() {
      const type = document.getElementById('export-type').value;
      const format = document.getElementById('export-format').value;
      const readerId = document.getElementById('export-reader').value;
      
      try {
        if (format === 'excel') {
          let url = `/api/admin/export-excel/${type}`;
          if (readerId) url += `?readerId=${readerId}`;
          
          const response = await fetch(url);
          const blob = await response.blob();
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `export_${type}_${Date.now()}.xlsx`;
          link.click();
          showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          return;
        }
        
        let url = `/api/admin/export/${type}?format=${format}`;
        if (readerId) url += `&readerId=${readerId}`;
        
        const response = await fetch(url, {
          credentials: 'include'
        });
        const data = await response.json();
        
        let content, filename, mimeType;
        if (format === 'json') {
          content = JSON.stringify(data, null, 2);
          filename = `export_${type}_${Date.now()}.json`;
          mimeType = 'application/json;charset=utf-8';
        } else {
          content = convertToCSV(data);
          filename = `export_${type}_${Date.now()}.csv`;
          mimeType = 'text/csv;charset=utf-8';
        }
        
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + content], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        showSuccess('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        showError('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
    }

    function convertToCSV(data) {
      if (!Array.isArray(data) || data.length === 0) return '';
      const headers = Object.keys(data[0]);
      const escapeCSV = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      };
      const rows = data.map(obj => headers.map(h => escapeCSV(obj[h])).join(','));
      return [headers.join(','), ...rows].join('\n');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showSuccess(message) {
      const alert = document.getElementById('successAlert');
      alert.textContent = message;
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 3000);
    }

    function showError(message) {
      const alert = document.getElementById('errorAlert');
      alert.textContent = message;
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 3000);
    }

    async function handleLogout() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;
      
      try {
        const response = await fetch('/api/admin/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        if (response.ok) {
          window.location.href = '/admin/login';
        } else {
          showError('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        }
      } catch (error) {
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    }

    loadData();
  </script>
</body>
</html>
